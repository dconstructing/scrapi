<!DOCTYPE html>
<html>
  <head>
    <link rel="shortcut icon" href="/baas/favicon.ico">

    <script type="text/javascript" src="/baas/lib/webcomponentsjs/webcomponents-lite.js"></script>
    <link rel="import" href="/baas/lib/polymer/polymer.html">
    <link rel="import" href="/baas/lib/paper-drawer-panel/paper-drawer-panel.html">
    <link rel="import" href="/baas/lib/paper-header-panel/paper-header-panel.html">
    <link rel="import" href="/baas/lib/paper-item/paper-item.html">
    <link rel="import" href="/baas/lib/paper-menu/paper-menu.html">
    <link rel="import" href="/baas/lib/iron-icons/iron-icons.html">
    <link rel="import" href="/baas/lib/iron-iconset-svg/iron-iconset-svg.html">
    <link rel="import" href="/baas/lib/iron-pages/iron-pages.html">
    <link rel="import" href="/baas/lib/paper-toolbar/paper-toolbar.html">
    <link rel="import" href="/baas/lib/google-signin/google-signin.html">
    <link rel="import" href="/baas/lib/paper-icon-button/paper-icon-button.html">
    <link rel="import" href="/baas/lib/more-routing/more-routing.html">
    <link rel="import" href="/baas/components/baas-user/baas-user.html">

    <!-- <link rel="import" href="/baas/routes.html"> -->

    <style>
      iron-pages section {
        padding: 10px;
      }
      baas-user:nth-child(odd) {
        background-color: #eee;
      }
      baas-user:nth-child(even) {
        background-color: #f7f7f7;
      }
    </style>
  </head>
  <body>
    <div id="result"></div>
    <template id="baas-main" is="auto-binding">
      <more-routing-config driver="path"></more-routing-config>

      <more-route name="home" path="/dashboard">
        <more-route name="users" path="/users"></more-route>
        <more-route name="motes" path="/motes"></more-route>
      </more-route>

      <paper-drawer-panel>
        <paper-header-panel drawer>
          <paper-toolbar>Main</paper-toolbar>
          <template is="dom-if" if="{{accessPermitted(userData)}}">
            <more-route-selector>
              <paper-menu>
                <paper-item route="home">Dashboard</paper-item>
                <paper-item route="users">Users</paper-item>
                <paper-item route="motes">Motes</paper-item>
              </paper-menu>
            </more-route-selector>
          </template>
        </paper-header-panel>
        <paper-header-panel main>
          <paper-toolbar>
            <paper-icon-button icon="menu" paper-drawer-toggle></paper-icon-button>
            <div flex>Baas</div>
            <google-signin brand="google" client-id="985826165186-iichhauleh34tfcgu01a1n0ptdabjd0o.apps.googleusercontent.com" scopes="https://www.googleapis.com/auth/plus.login email" on-google-signin-aware-success="signedIn" on-google-signin-failure="notSignedIn" on-google-signin-aware-signed-out="signedOut"></google-signin>
          </paper-toolbar>
          <div class="container" fit vertical layout>
            <more-route-selector>
              <iron-pages flex>
                <section route="home">
                  <p>Welcome to Baas Dashboard!</p>
                </section>
                <section route="users">
                  <template is="dom-if" if="{{accessPermitted(userData)}}">
                    <template is="dom-repeat" items="{{resources.users}}">
                      <baas-user user="{{item}}" on-user-updated="userUpdated"></baas-user>
                    </template>
                  </template>
                </section>
                <section route="motes">
                  <template is="dom-if" if="{{accessPermitted(userData)}}">
                    <template is="dom-repeat" items="{{resources.motes}}">
                      <form on-submit="moteUpdated">
                        <input type="hidden" name="index" value="{{index}}" />
                        <input type="hidden" name="_id" value="{{item._id}}" />
                        <input type="text" name="label" value="{{item.label::input}}" />
                        <input type="text" name="type" value="{{item.type}}" />
                        <input type="text" name="state" value="{{item.state}}" />
                        <button type="submit">Save</button>
                      </form>
                    </template>
                  </template>
                </section>
              </iron-pages>
            </more-route-selector>
          </div>
        </paper-header-panel>
      </paper-drawer-panel>
    </template>
    <script>
      var Baas = function() {
        this.authenticateUser = function(unverifiedToken, callback) {
          var payload = {
            service: 'google',
            token: unverifiedToken
          };

          var xhr = new XMLHttpRequest();
          xhr.open('POST', '/auth/social', true);
          xhr.setRequestHeader('Content-Type', 'application/json');
          xhr.onload = function(e) {
            var data = JSON.parse(this.response);
            callback(data);
          };
          xhr.send(JSON.stringify(payload));
        };
      };

      var baas = new Baas();

      var token;

      var template = document.getElementById('baas-main');
      template.accessPermitted = function(userData) {
        // do something to actually check access
        if (userData.permissions && userData.permissions.admin) {
          return true;
        }
        return false;
      };
      template.userData = {};
      template.availableResources = [];
      template.resources = {
        motes: [],
        users: []
      };

      template.signedIn = function(event, detail, sender) {
        console.log('signed in', detail);
        if (detail.access_token) {
          token = detail.access_token;
          baas.authenticateUser(token, function(data) {
            console.log('callback data', data);
            template.userData = data;
            loadData();
          });
        }
      };
      template.notSignedIn = function(event, detail, sender) {
        console.log('not signed in', detail);
      };
      template.signedOut = function(event, detail, sender) {
        template.userData = {};
        // clearData();
      };
      template.userUpdated = function(event, details, sender) {
        var xhr = new XMLHttpRequest();
        xhr.open('PUT', '/users/' + details._id, true);
        xhr.setRequestHeader('Authorization', 'Bearer ' + token);
        xhr.setRequestHeader('Content-Type', 'application/json');
        xhr.onload = function(e) {
          console.log('put', this.response);
        };
        xhr.send(JSON.stringify(details));
      };
      template.moteUpdated = function(event, details, sender) {
        console.log('mote updated', event, details, sender);
        event.preventDefault();

        var data = template.resources.motes[event.model.index];
        var data = event.model.item;
        console.log('data', data);

        var xhr = new XMLHttpRequest();
        xhr.open('PUT', '/motes/' + data._id, true);
        xhr.setRequestHeader('Authorization', 'Bearer ' + token);
        xhr.setRequestHeader('Content-Type', 'application/json');
        xhr.onload = function(e) {
          console.log('put', this.response);
        };
        xhr.send(JSON.stringify(data));
        event.preventDefault();
      };
      template.resourceSelected = function(event, details, sender) {
        sender = sender || event.target;
        MoreRouting.navigateTo('resource', {resourceType: sender.getAttribute('resource-type')});
      };

      var loadData = function() {
        if (template.accessPermitted(template.userData)) {
          var xhr = new XMLHttpRequest();
          xhr.open('GET', '/resources', true);
          xhr.setRequestHeader('Authorization', 'Bearer ' + token);
          xhr.setRequestHeader('Accept', 'application/json');
          xhr.onload = function(e) {
            console.log('resources', JSON.parse(this.response));

            template.availableResources = JSON.parse(this.response);
            var container = document.querySelector('more-route-selector > paper-menu');
            template.availableResources.forEach(function(resource) {
              loadResource(resource);
              // var item = document.createElement('paper-item');
              // item.setAttribute('route', resource);
              // item.textContent = resource;
              // // item.addEventListener('tap', template.resourceSelected);
              // container.appendChild(item);
            });
            // document.querySelector('more-route-selector')._updateRoutes();
          };
          xhr.send();
        }
      };
      var loadResource = function(type) {
        var xhr = new XMLHttpRequest();
        xhr.open('GET', '/' + type, true);
        xhr.setRequestHeader('Authorization', 'Bearer ' + token);
        xhr.setRequestHeader('Accept', 'application/json');
        xhr.onload = function(e) {
          var json = JSON.parse(this.response);
          console.log(type, json);
          json.forEach(function(resource) {
            template.push('resources.'+type, resource);
          });
        };
        xhr.send();
      };
    </script>
  </body>
</html>
